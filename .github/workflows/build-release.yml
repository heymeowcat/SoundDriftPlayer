name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Dependencies
      working-directory: ./SoundDriftPlayer-app
      run: npm install

    - name: Build Electron App
      working-directory: ./SoundDriftPlayer-app
      run: npm run make

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          SoundDriftPlayer-app/out/make/squirrel.windows/x64/*.exe

  build-linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Linux Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm libasound2-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

    - name: Install Dependencies
      working-directory: ./SoundDriftPlayer-app
      run: npm install

    - name: Build Electron App
      working-directory: ./SoundDriftPlayer-app
      run: npm run make

    - name: Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: linux-deb
        path: SoundDriftPlayer-app/out/make/deb/x64/*.deb

    - name: Upload Linux RPM
      uses: actions/upload-artifact@v4
      with:
        name: linux-rpm
        path: SoundDriftPlayer-app/out/make/rpm/x64/*.rpm

    - name: Upload Linux ZIP
      uses: actions/upload-artifact@v4
      with:
        name: linux-zip
        path: SoundDriftPlayer-app/out/make/zip/linux/x64/*.zip

  build-macos-arm:
    name: macOS ARM Build
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install macOS Build Dependencies
      run: |
        brew install cairo pango librsvg pkg-config

    - name: Install Dependencies
      working-directory: ./SoundDriftPlayer-app
      run: npm install

    - name: Build Electron App for ARM64
      working-directory: ./SoundDriftPlayer-app
      run: npm run make -- --arch=arm64

    - name: Upload macOS ARM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm-builds
        path: |
          SoundDriftPlayer-app/out/make/*.dmg

  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release-assets

    - name: List All Downloaded Files
      run: find ./release-assets -type f -name "*"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./release-assets/**/*.exe
          ./release-assets/**/*.deb
          ./release-assets/**/*.rpm
          ./release-assets/**/*.zip
          ./release-assets/**/*.dmg
        generate_release_notes: true
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
